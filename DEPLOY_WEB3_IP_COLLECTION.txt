=====================================================
WEB3 IP COLLECTION TIZIMI - O'RNATISH
=====================================================

NIMALAR QO'SHILDI:
-----------------------------------------------------

1. WEB-BASED REAL IP COLLECTION
   âœ… Foydalanuvchining haqiqiy IP manzilini yig'ish
   âœ… Telegram API serveri IP emas, foydalanuvchi IP
   âœ… Xavfsiz token bilan himoyalangan
   âœ… Chiroyli web sahifa (gradient dizayn)
   âœ… Avtomatik IP yig'ish va saqlash
   âœ… Cloudflare, Nginx proxy headerlarini qo'llab-quvvatlaydi

2. FRAUD PREVENTION TIZIMI
   âœ… IP-based limiting: Bir IP dan max 10 ovoz
   âœ… Phone prefix-based limiting: Bir operator prefiksidan max 10 ovoz
   âœ… Rate limiting: Har 10 soniyada max 1 ovoz
   âœ… Batafsil logging xavfsizlik hodisalari uchun

3. YANGI FAYLLAR
   - app/Http/Controllers/Api/IpCollectorController.php
   - resources/views/ip-collector.blade.php
   - database/migrations/2025_12_21_000001_add_ip_verified_to_poll_participants.php

4. O'ZGARTIRILGAN FAYLLAR
   - app/Services/PollBotService.php
   - app/Models/PollParticipant.php
   - routes/api.php

=====================================================
JARAYON QANDAY ISHLAYDI:
=====================================================

1. Foydalanuvchi nomzod tugmasini bosadi
2. Bot xavfsizlik tekshiruvini so'raydi
3. Foydalanuvchi "ðŸ” Xavfsizlik tekshiruvi" tugmasini bosadi
4. Brauzerda web sahifa ochiladi
5. Sahifa avtomatik ravishda foydalanuvchining haqiqiy IP ni oladi
6. IP database ga saqlanadi (poll_participants.ip_address)
7. Foydalanuvchi Telegram botga qaytadi
8. "âœ… Davom etish" tugmasini bosadi
9. Bot telefon, obuna, recaptcha tekshiruvlarini o'tkazadi
10. Ovoz berishdan oldin fraud prevention tekshiruvlari:
    - Bir IP dan 10 tadan ortiq ovoz yo'qligini tekshiradi
    - Bir telefon prefiksdan 10 tadan ortiq ovoz yo'qligini tekshiradi
    - 10 soniya ichida takror ovoz yo'qligini tekshiradi
11. Agar barchasi OK bo'lsa - ovoz qabul qilinadi

=====================================================
SERVERGA O'RNATISH:
=====================================================

1. FAYLLARNI YUKLASH
-----------------------------------------------------

Local kompyuterdan serverga:

scp app/Http/Controllers/Api/IpCollectorController.php root@161.97.88.95:/var/www/telegram-bot-channels-manager/app/Http/Controllers/Api/

scp resources/views/ip-collector.blade.php root@161.97.88.95:/var/www/telegram-bot-channels-manager/resources/views/

scp app/Services/PollBotService.php root@161.97.88.95:/var/www/telegram-bot-channels-manager/app/Services/

scp app/Models/PollParticipant.php root@161.97.88.95:/var/www/telegram-bot-channels-manager/app/Models/

scp routes/api.php root@161.97.88.95:/var/www/telegram-bot-channels-manager/routes/

scp database/migrations/2025_12_21_000001_add_ip_verified_to_poll_participants.php root@161.97.88.95:/var/www/telegram-bot-channels-manager/database/migrations/


2. SERVERDA MIGRATION ISHLATISH
-----------------------------------------------------

ssh root@161.97.88.95

cd /var/www/telegram-bot-channels-manager

# Migration ishlatish
php artisan migrate

# Natija:
# Migration table created successfully.
# Migrating: 2025_12_21_000001_add_ip_verified_to_poll_participants
# Migrated:  2025_12_21_000001_add_ip_verified_to_poll_participants


3. CACHE TOZALASH
-----------------------------------------------------

php artisan config:clear
php artisan cache:clear
php artisan view:clear
php artisan route:clear


4. RUXSATLARNI TEKSHIRISH
-----------------------------------------------------

chmod -R 775 storage
chown -R www-data:www-data storage


=====================================================
TEST QILISH:
=====================================================

1. Yangi so'rovnoma yarating yoki mavjudini oching

2. Nomzod tugmasini bosing

3. Quyidagi jarayonni kuzating:

   âœ… "ðŸ” Xavfsizlik tekshiruvi" xabari chiqishi kerak
   âœ… "Xavfsizlik tekshiruvi" tugmasini bosing
   âœ… Brauzerda chiroyli gradient sahifa ochilishi kerak
   âœ… "Xavfsizlik tekshiruvi muvaffaqiyatli o'tdi" xabari chiqishi kerak
   âœ… Sizning IP manzilingiz ko'rsatilishi kerak
   âœ… Telegram botga qaytib "âœ… Davom etish" tugmasini bosing
   âœ… Telefon raqam so'rashi kerak (agar yoqilgan bo'lsa)
   âœ… Kanal obunasi tekshirishi kerak (agar yoqilgan bo'lsa)
   âœ… ReCaptcha ko'rsatishi kerak (agar yoqilgan bo'lsa)
   âœ… Ovoz qabul qilinishi kerak

4. Loglarni kuzating:

tail -f storage/logs/laravel.log

Quyidagi loglar ko'rinishi kerak:

- "Requesting IP verification" - IP tekshiruvi so'ralganda
- "IP Collection" - IP yig'ilganda
- "IP Updated Successfully" - IP saqlanganda
- "Vote recorded successfully" - Ovoz qabul qilinganda
  (real_ip bilan birga)


=====================================================
FRAUD PREVENTION NI TEST QILISH:
=====================================================

1. IP LIMIT TEST (10 marta)
-----------------------------------------------------

Bir xil IP dan 11 marta ovoz berishga harakat qiling.
11-chi ovozda xato chiqishi kerak:

"âŒ Xavfsizlik: Sizning IP manzilingizdan haddan ortiq
ko'p ovoz berilgan. Agar bu xato deb hisoblasangiz,
administrator bilan bog'laning."


2. PHONE PREFIX LIMIT TEST
-----------------------------------------------------

+998901234567 dan boshlanadigan 10 ta raqam bilan
ovoz bering. 11-chida xato chiqishi kerak:

"âŒ Xavfsizlik: Sizning telefon operatoringizdan haddan
ortiq ko'p ovoz berilgan."


3. RATE LIMIT TEST
-----------------------------------------------------

Tez-tez ovoz berishga harakat qiling (10 soniya ichida).
Xato chiqishi kerak:

"âŒ Juda tez ovoz berayapsiz. Iltimos, 10 soniya
kuting va qaytadan urinib ko'ring."


=====================================================
MUAMMOLARNI HAL QILISH:
=====================================================

MUAMMO 1: IP sahifasi ochilmayapti
-----------------------------------------------------

Tekshirish:

curl https://admin.ishchi-bozor.uz/api/ip-collector?poll_id=1&chat_id=123&token=test

Agar 400 yoki 403 xato chiqsa - to'g'ri.
Agar 404 chiqsa - route ishlamayapti.

Yechim:
php artisan route:clear
php artisan route:cache


MUAMMO 2: IP saqlanmayapti
-----------------------------------------------------

Logni kuzating:

tail -f storage/logs/laravel.log | grep "IP Collection"

"IP Collection" va "IP Updated Successfully" loglarini
qidiring.

Agar IP null bo'lsa:
- Proxy headerlarni tekshiring (Cloudflare, Nginx)
- REMOTE_ADDR headerini tekshiring


MUAMMO 3: Fraud prevention ishlamayapti
-----------------------------------------------------

Logni kuzating:

tail -f storage/logs/laravel.log | grep "warning"

"IP vote limit exceeded" yoki "Phone prefix vote limit
exceeded" loglarini qidiring.

Agar log chiqmasa:
- Migration to'g'ri ishlaganligini tekshiring
- ip_verified column mavjudligini tekshiring:

mysql -u root -p
use telegram_bot_db;
DESCRIBE poll_participants;


=====================================================
XAVFSIZLIK SOZLAMALARI (OPTIONAL):
=====================================================

Agar limitlarni o'zgartirmoqchi bo'lsangiz:

app/Services/PollBotService.php faylida:

// IP limiti (hozirda 10)
if ($ipVoteCount >= 10) {  // Bu yerda o'zgartiring

// Telefon prefix limiti (hozirda 10)
if ($prefixVoteCount >= 10) {  // Bu yerda o'zgartiring

// Rate limit (hozirda 10 soniya)
->where('voted_at', '>', now()->subSeconds(10))  // Bu yerda


=====================================================
IP MANZILLARNI KO'RISH:
=====================================================

Admin panelda:

1. Poll Votes bo'limiga o'ting
2. Har bir ovozning IP manzili ko'rinadi
3. Filter qilish: IP bo'yicha filter qo'shing

Yoki database orqali:

mysql -u root -p
use telegram_bot_db;

SELECT
    pv.id,
    pp.phone,
    pp.ip_address as participant_ip,
    pv.ip_address as vote_ip,
    pv.voted_at
FROM poll_votes pv
JOIN poll_participants pp ON pv.poll_participant_id = pp.id
WHERE pv.poll_id = 1
ORDER BY pv.voted_at DESC;


=====================================================
WEB3 HAQIDA:
=====================================================

Texnik jihatdan bu "Web3" emas, lekin foydalanuvchining
haqiqiy IP manzilini to'g'ridan-to'g'ri brauzeridan
olish imkonini beradi.

Telegram Bot API orqali faqat Telegram serverining IP
manzilini olish mumkin edi. Endi biz foydalanuvchining
haqiqiy IP manzilini olamiz va fraud preventionni
samaraliroq qo'llaymiz.

IP Collection sahifasi:
- Gradient dizayn (chiroyli ko'rinish)
- Avtomatik IP yig'ish (JavaScript)
- Xavfsiz token bilan himoyalangan
- Cloudflare/Nginx proxy headerlarini qo'llab-quvvatlaydi
- Real-time status ko'rsatish
- 3 soniyadan keyin avtomatik yopilish

=====================================================
QO'SHIMCHA XAVFSIZLIK (KELAJAKDA):
=====================================================

Agar kerak bo'lsa qo'shish mumkin:

1. Device Fingerprinting
   - Browser fingerprint orqali qurilmani aniqlash

2. GeoIP Blocking
   - Muayyan mamlakatlardan ovozni bloklash

3. VPN/Proxy Detection
   - VPN/Proxy IP larni aniqlash va bloklash

4. Google reCaptcha v3
   - Bot score asosida avtomatik bloklash

5. SMS Verification
   - Telefon raqamni SMS orqali tasdiqlash

=====================================================
